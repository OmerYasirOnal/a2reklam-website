---
interface Props {
  images: Array<{
    paths: {
      '480'?: string;
      '960'?: string;
      '1600'?: string;
    };
    category?: string;
    alt?: string;
  }>;
  lang?: 'tr' | 'en' | 'ar';
  category?: string;
  initialLimit?: number;
  aspectRatio?: 'square' | 'video' | 'auto';
  galleryId?: string;
}

const {
  images,
  lang = 'tr',
  category = '',
  initialLimit = 12,
  aspectRatio = 'square',
  galleryId = 'a2-gallery-grid',
} = Astro.props;

// Use 4:3 aspect ratio for better consistency across different image types
const aspectClass = aspectRatio === 'video' ? 'aspect-video' : aspectRatio === 'auto' ? 'aspect-auto' : 'aspect-[4/3]';

// Translations
const translations = {
  tr: {
    loadMore: 'Daha Fazla Yükle',
    imageOf: 'Görsel',
  },
  en: {
    loadMore: 'Load More',
    imageOf: 'Image',
  },
  ar: {
    loadMore: 'المزيد',
    imageOf: 'صورة',
  },
};

const t = translations[lang];
const hasMore = images.length > initialLimit;
const visibleImages = images.slice(0, initialLimit);
const remainingCount = images.length - initialLimit;
---

<div class="not-prose gallery-container" data-gallery-id={galleryId}>
  <div
    id="gallery-grid"
    class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
    data-total={images.length}
    data-limit={initialLimit}
  >
    {visibleImages.map((img, idx) => {
      const src480 = img.paths?.['480'] || img.paths?.['960'] || '';
      const src960 = img.paths?.['960'] || img.paths?.['1600'] || '';
      const src1600 = img.paths?.['1600'] || img.paths?.['960'] || '';
      const alt = img.alt || `Gallery image ${idx + 1}`;
      const srcset = src480 && src960 && src1600
        ? `${src480} 480w, ${src960} 960w, ${src1600} 1600w`
        : undefined;

      return (
        <a
          href={src1600}
          class="glightbox gallery-item group relative overflow-hidden rounded-xl bg-surface border border-white/5 hover:border-primary/50 transition-all duration-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-secondary block"
          data-gallery={galleryId}
          data-index={idx}
          data-category={img.category || category}
          aria-label={`${t.imageOf} ${idx + 1}: ${alt}`}
        >
          <div class={`${aspectClass} overflow-hidden`}>
            <img
              src={src480 || src960}
              srcset={srcset}
              sizes="(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
              alt={alt}
              loading="lazy"
              decoding="async"
              width="480"
              height={aspectRatio === 'video' ? '270' : aspectRatio === 'auto' ? undefined : '360'}
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            />
          </div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          <div class="absolute inset-0 ring-1 ring-inset ring-white/10 group-hover:ring-primary/50 transition-all rounded-xl pointer-events-none"></div>
        </a>
      );
    })}
  </div>

  {hasMore && (
    <div class="text-center mt-8">
      <button
        type="button"
        id="load-more-btn"
        class="btn btn-secondary px-8 py-3"
        data-remaining={remainingCount}
      >
        {t.loadMore} ({remainingCount})
      </button>
    </div>
  )}
</div>

<script define:vars={{ allImages: images, totalImages: images.length, initialLimit, aspectRatio, t, category, galleryId }}>
  (function() {
    const container = document.currentScript?.previousElementSibling?.closest('.gallery-container') || document.querySelector(`.gallery-container[data-gallery-id="${galleryId}"]`);
    if (!container) return;

    const loadMoreBtn = container.querySelector('#load-more-btn');
    const galleryGrid = container.querySelector('#gallery-grid');

    // Load more functionality
    if (loadMoreBtn && galleryGrid) {
      const limit = parseInt(galleryGrid.getAttribute('data-limit') || '12');
      const total = parseInt(galleryGrid.getAttribute('data-total') || String(totalImages));
      let currentLoaded = initialLimit;

      loadMoreBtn.addEventListener('click', () => {
        const remaining = total - currentLoaded;
        const toLoad = Math.min(limit, remaining);

        if (toLoad <= 0) {
          if (loadMoreBtn) loadMoreBtn.style.display = 'none';
          return;
        }

        // Create and append new items
        for (let i = currentLoaded; i < currentLoaded + toLoad && i < allImages.length; i++) {
          const imgData = allImages[i];
          const src480 = imgData.paths?.['480'] || imgData.paths?.['960'] || '';
          const src960 = imgData.paths?.['960'] || imgData.paths?.['1600'] || '';
          const src1600 = imgData.paths?.['1600'] || imgData.paths?.['960'] || '';
          const alt = imgData.alt || `Gallery image ${i + 1}`;
          const srcset = src480 && src960 && src1600
            ? `${src480} 480w, ${src960} 960w, ${src1600} 1600w`
            : undefined;

          const aspectClass = aspectRatio === 'video' ? 'aspect-video' : aspectRatio === 'auto' ? 'aspect-auto' : 'aspect-[4/3]';
          const itemCategory = imgData.category || category;

          const anchor = document.createElement('a');
          anchor.href = src1600;
          anchor.className = 'glightbox gallery-item group relative overflow-hidden rounded-xl bg-surface border border-white/5 hover:border-primary/50 transition-all duration-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-secondary block';
          anchor.setAttribute('data-gallery', galleryId);
          anchor.setAttribute('data-index', String(i));
          anchor.setAttribute('data-category', itemCategory);
          anchor.setAttribute('aria-label', `${t.imageOf} ${i + 1}: ${alt}`);

          anchor.innerHTML = `
            <div class="${aspectClass} overflow-hidden bg-surface">
              <img
                src="${src480 || src960}"
                ${srcset ? `srcset="${srcset}" sizes="(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"` : ''}
                alt="${alt}"
                loading="lazy"
                decoding="async"
                width="480"
                height="${aspectRatio === 'video' ? '270' : '360'}"
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              />
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="absolute inset-0 ring-1 ring-inset ring-white/10 group-hover:ring-primary/50 transition-all rounded-xl pointer-events-none"></div>
          `;

          if (galleryGrid) galleryGrid.appendChild(anchor);
        }

        currentLoaded += toLoad;
        const remainingAfter = total - currentLoaded;

        if (remainingAfter <= 0) {
          if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        } else {
          if (loadMoreBtn) loadMoreBtn.textContent = `${t.loadMore} (${remainingAfter})`;
        }

        // Re-initialize GLightbox to include new items
        if (window.__a2_glightbox_reinit__) {
          window.__a2_glightbox_reinit__();
        }
      });
    }
  })();
</script>

<script>
  import '../../scripts/glightbox-init';
</script>

<style>
  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .gallery-item img {
      transition: none;
    }
  }
</style>
