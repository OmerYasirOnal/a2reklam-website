---
import { getLocaleAlternates } from '../../utils/localeRoutes';

interface Props {
  lang?: string;
}

const { lang = 'tr' } = Astro.props;

const isRtl = lang === 'ar';
const alternates = getLocaleAlternates(Astro.url.pathname);

const items_tr = [
  { label: 'Anasayfa', href: '/' },
  { label: 'Hizmetler', href: '/hizmetler/' },
  { label: 'Galeri', href: '/galeri/' },
  { label: 'Hakkımızda', href: '/hakkimizda/' },
  { label: 'S.S.S', href: '/sss/' },
  { label: 'İletişim', href: '/iletisim/' },
];

const items_en = [
  { label: 'Home', href: '/en/' },
  { label: 'Services', href: '/en/services/' },
  { label: 'Gallery', href: '/en/gallery/' },
  { label: 'About Us', href: '/en/about/' },
  { label: 'F.A.Q', href: '/en/faq/' },
  { label: 'Contact', href: '/en/contact/' },
];

const items_ar = [
  { label: 'الرئيسية', href: '/ar/' },
  { label: 'الخدمات', href: '/ar/services/' },
  { label: 'المعرض', href: '/ar/gallery/' },
  { label: 'اتصل بنا', href: '/ar/contact/' },
  { label: 'احصل على عرض سعر', href: '/ar/get-quote/' },
];

const items = lang === 'en' ? items_en : lang === 'ar' ? items_ar : items_tr;
const homeLink = lang === 'en' ? '/en/' : lang === 'ar' ? '/ar/' : '/';
const quoteLink = lang === 'en' ? '/en/get-quote/' : lang === 'ar' ? '/ar/get-quote/' : '/teklif-al/';
const quoteLabel = lang === 'en' ? 'Get Quote' : lang === 'ar' ? 'احصل على عرض سعر' : 'Teklif Al';
const menuLabel = lang === 'en' ? 'Menu' : lang === 'ar' ? 'القائمة' : 'Menü';
const closeLabel = lang === 'en' ? 'Close' : lang === 'ar' ? 'إغلاق' : 'Kapat';

const languageLabels = { tr: 'Türkçe', en: 'English', ar: 'العربية' };
const languageOrder = ['tr', 'en', 'ar'] as const;
const languageLinks = languageOrder
  .filter((locale) => alternates[locale])
  .map((locale) => ({
    locale,
    href: alternates[locale],
    label: languageLabels[locale],
  }));
---

<header class="sticky top-0 z-50 glass-bar transition-all duration-300">
  <div class:list={['container mx-auto px-4 h-20 flex items-center justify-between', isRtl && 'flex-row-reverse']}>
    <a href={homeLink} class="font-heading font-black text-2xl tracking-tighter text-white flex items-center gap-2">
      <span class="text-primary text-3xl">A2</span> REKLAM
    </a>

    <nav class:list={['hidden md:flex items-center gap-8', isRtl && 'flex-row-reverse']}>
      {items.map(item => (
        <a href={item.href} class="text-sm font-medium text-gray-300 hover:text-primary transition-colors uppercase tracking-wide">
          {item.label}
        </a>
      ))}
    </nav>

    <div class:list={['flex items-center gap-2 md:gap-4', isRtl && 'flex-row-reverse']}>
      <!-- Language Switcher (always visible) -->
      <div class="hidden md:flex items-center gap-1 md:gap-2">
        {languageLinks.map((link) => (
          <a
            href={link.href}
            class:list={[
              'text-xs font-bold border px-2 py-1 md:px-3 md:py-1.5 rounded transition-colors whitespace-nowrap',
              link.locale === lang ? 'border-primary text-primary' : 'border-white/20 text-gray-300 hover:text-white hover:border-white',
            ]}
            aria-current={link.locale === lang ? 'page' : undefined}
          >
            {link.label}
          </a>
        ))}
      </div>

      <!-- Quote Button (desktop only) -->
      <a href={quoteLink} data-track="lead-click" data-lead-type="quote" data-lang={lang} class="hidden md:inline-flex btn btn-primary px-6 py-2.5 text-sm font-bold">
        {quoteLabel}
      </a>

      <!-- Mobile Menu Toggle -->
      <button
        id="mobile-menu-toggle"
        type="button"
        class="md:hidden p-2 text-white hover:text-primary transition-colors"
        aria-expanded="false"
        aria-controls="mobile-menu-panel"
        aria-haspopup="dialog"
        aria-label={menuLabel}
      >
        <svg id="hamburger-icon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="close-icon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Menu Drawer -->
<div
  id="mobile-menu"
  class:list={[
    'fixed inset-0 z-[60] transform transition-transform duration-300 md:hidden pointer-events-none',
    isRtl ? '-translate-x-full' : 'translate-x-full'
  ]}
  aria-hidden="true"
  inert
  data-rtl={isRtl ? 'true' : 'false'}
>
  <!-- Backdrop -->
  <div
    id="mobile-menu-backdrop"
    class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"
    aria-hidden="true"
    tabindex="-1"
  ></div>

  <!-- Drawer Panel -->
  <div
    id="mobile-menu-panel"
    class:list={[
      'absolute top-0 h-full w-80 max-w-[85vw] bg-secondary/95 backdrop-blur-lg border-white/10 p-6',
      isRtl ? 'left-0 border-r' : 'right-0 border-l'
    ]}
    role="dialog"
    aria-modal="true"
    aria-labelledby="mobile-menu-title"
    tabindex="-1"
  >
    <h2 id="mobile-menu-title" class="sr-only">{menuLabel}</h2>
    <nav class="flex flex-col h-full" aria-label={menuLabel}>
      <!-- Close Button -->
      <div class:list={['flex justify-end mb-8', isRtl && 'justify-start']}>
        <button
          id="mobile-menu-close"
          type="button"
          class="p-2 text-gray-400 hover:text-white transition-colors"
          aria-label={closeLabel}
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Navigation Links -->
      <div class="flex-1 space-y-1">
        {items.map(item => (
          <a
            href={item.href}
            class:list={[
              'block py-3 px-4 text-lg font-medium text-gray-200 hover:text-primary hover:bg-white/5 rounded-lg transition-colors',
              isRtl && 'text-right'
            ]}
          >
            {item.label}
          </a>
        ))}
      </div>

      <!-- Language Switcher (Mobile) -->
      <div class="border-t border-white/10 pt-6 mt-6">
        <div class:list={['flex items-center gap-2 mb-4', isRtl && 'flex-row-reverse justify-end']}>
          {languageLinks.map((link) => (
            <a
              href={link.href}
              class:list={[
                'text-sm font-bold border px-3 py-1.5 rounded transition-colors',
                link.locale === lang ? 'border-primary text-primary' : 'border-white/20 text-gray-300 hover:text-white hover:border-white',
              ]}
              aria-current={link.locale === lang ? 'page' : undefined}
            >
              {link.label}
            </a>
          ))}
        </div>

        <!-- Quote Button (Mobile) -->
        <a
          href={quoteLink}
          data-track="lead-click"
          data-lead-type="quote"
          data-lang={lang}
          class="block w-full text-center btn btn-primary py-3 text-sm font-bold"
        >
          {quoteLabel}
        </a>
      </div>
    </nav>
  </div>
</div>

<script>
  function initMobileMenu() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const panel = document.getElementById('mobile-menu-panel');
    const backdrop = document.getElementById('mobile-menu-backdrop');
    const closeBtn = document.getElementById('mobile-menu-close');
    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');

    if (!toggle || !menu || !panel || !backdrop || !closeBtn) return;
    if (menu.dataset.initialized === 'true') return;
    menu.dataset.initialized = 'true';

    const isRtl = menu.dataset.rtl === 'true';
    const openClass = 'translate-x-0';
    const closedClass = isRtl ? '-translate-x-full' : 'translate-x-full';

    function getFocusableElements() {
      return Array.from(
        panel.querySelectorAll(
          'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )
      );
    }

    function openMenu() {
      menu.classList.remove(closedClass);
      menu.classList.add(openClass);
      menu.setAttribute('aria-hidden', 'false');
      menu.classList.remove('pointer-events-none');
      menu.removeAttribute('inert');
      toggle.setAttribute('aria-expanded', 'true');
      backdrop.classList.remove('opacity-0');
      backdrop.classList.add('opacity-100');
      hamburgerIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Focus first focusable
      const focusable = getFocusableElements();
      const firstLink = focusable[0];
      if (firstLink) firstLink.focus();
    }

    function closeMenu() {
      menu.classList.remove(openClass);
      menu.classList.add(closedClass);
      menu.setAttribute('aria-hidden', 'true');
      menu.classList.add('pointer-events-none');
      menu.setAttribute('inert', '');
      toggle.setAttribute('aria-expanded', 'false');
      backdrop.classList.remove('opacity-100');
      backdrop.classList.add('opacity-0');
      hamburgerIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      document.body.style.overflow = '';
      toggle.focus();
    }

    // Toggle button click
    toggle.addEventListener('click', () => {
      const isOpen = toggle.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close button click
    closeBtn.addEventListener('click', closeMenu);

    // Backdrop click
    backdrop.addEventListener('click', closeMenu);

    // ESC key
    document.addEventListener('keydown', (e) => {
      if (toggle.getAttribute('aria-expanded') !== 'true') return;
      if (e.key === 'Escape' && toggle.getAttribute('aria-expanded') === 'true') {
        closeMenu();
        return;
      }
      if (e.key !== 'Tab') return;
      const focusable = getFocusableElements();
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });

    // Close on navigation (for SPA-like behavior)
    menu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        setTimeout(closeMenu, 100);
      });
    });
  }

  // Initialize on page load
  initMobileMenu();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initMobileMenu);
</script>
