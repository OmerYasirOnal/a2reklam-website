---
import { loadImagesManifest } from '../../utils/imagesManifest';
import { buildImageAlt, getCategoryLabel } from '../../utils/imageSeo';

interface Props {
  lang?: 'tr' | 'en' | 'ar';
  maxImages?: number;
}

const { lang = 'tr', maxImages = 20 } = Astro.props;
const isRtl = lang === 'ar';

// Load manifest and select diverse images
const manifest = loadImagesManifest();
const categories = [...new Set(manifest.map((m: any) => m.category))];

// Select 2 images per category for diversity
const selectedImages: any[] = [];
categories.forEach((cat) => {
  const catImages = manifest.filter((m: any) => m.category === cat);
  selectedImages.push(...catImages.slice(0, 2));
});

// Limit to maxImages and build deterministic alts for lightbox
const displayImages = selectedImages.slice(0, maxImages).map((img: any) => ({
  ...img,
  alt: buildImageAlt({ category: img.category, lang }),
}));

// Translations
const t = {
  tr: {
    title: 'Projelerimiz',
    subtitle: 'Örnek çalışmalarımıza göz atın',
    viewAll: 'Tümünü Gör',
    viewAllLink: '/galeri/',
    prev: 'Önceki',
    next: 'Sonraki',
    image: 'Görsel',
  },
  en: {
    title: 'Our Projects',
    subtitle: 'Browse our sample works',
    viewAll: 'View All',
    viewAllLink: '/en/gallery/',
    prev: 'Previous',
    next: 'Next',
    image: 'Image',
  },
  ar: {
    title: 'مشاريعنا',
    subtitle: 'تصفح أعمالنا',
    viewAll: 'عرض الكل',
    viewAllLink: '/ar/gallery/',
    prev: 'السابق',
    next: 'التالي',
    image: 'صورة',
  },
}[lang];
---

<section class="py-16 bg-secondary/80 border-y border-white/5 overflow-hidden gallery-slider-section">
  <div class="container mx-auto px-4 mb-8">
    <div class:list={['flex items-end justify-between gap-4', isRtl && 'flex-row-reverse']}>
      <div class:list={[isRtl && 'text-right']}>
        <h2 class="font-heading font-black text-3xl md:text-4xl text-white mb-2">
          <span class="text-primary">{t.title.split(' ')[0]}</span>{' '}{t.title.split(' ').slice(1).join(' ')}
        </h2>
        <p class="text-gray-400">{t.subtitle}</p>
      </div>
      <div class:list={['flex items-center gap-3', isRtl && 'flex-row-reverse']}>
        <a
          href={t.viewAllLink}
          class="hidden sm:inline-flex text-sm font-medium text-primary hover:text-primary-hover transition-colors"
        >
          {t.viewAll} →
        </a>
        <div class:list={['flex gap-2', isRtl && 'flex-row-reverse']}>
          <button
            type="button"
            id="slider-prev"
            class="slider-nav-btn p-3 rounded-full border border-white/10 text-gray-400 hover:border-primary hover:text-primary transition-all focus:outline-none focus:ring-2 focus:ring-primary"
            aria-label={t.prev}
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={isRtl ? "M9 5l7 7-7 7" : "M15 19l-7-7 7-7"} />
            </svg>
          </button>
          <button
            type="button"
            id="slider-next"
            class="slider-nav-btn p-3 rounded-full border border-white/10 text-gray-400 hover:border-primary hover:text-primary transition-all focus:outline-none focus:ring-2 focus:ring-primary"
            aria-label={t.next}
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={isRtl ? "M15 19l-7-7 7-7" : "M9 5l7 7-7 7"} />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="gallery-slider-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <!-- Slider Track -->
  <div
    id="gallery-slider"
    class:list={[
      'flex gap-4 overflow-x-auto snap-x scroll-smooth pb-4 px-4 slider-no-scrollbar',
      isRtl && 'flex-row-reverse'
    ]}
    style="scroll-snap-type: x proximity; scroll-padding-inline: 1rem;"
    role="region"
    aria-label={t.title}
  >
    {displayImages.map((img, idx) => {
      const src480 = img.paths?.['480'] || img.paths?.['960'] || '';
      const src960 = img.paths?.['960'] || img.paths?.['1600'] || '';
      const src1600 = img.paths?.['1600'] || img.paths?.['960'] || '';
      const alt = img.alt || buildImageAlt({ category: img.category, lang });
      const categoryLabel = getCategoryLabel(img.category, lang);

      return (
        <a
          href={src1600}
          class="glightbox slider-item group flex-shrink-0 w-72 md:w-80 snap-start relative rounded-xl overflow-hidden cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-secondary border border-white/5 hover:border-primary/50 transition-all block"
          data-gallery="a2-gallery-slider"
          data-index={idx}
          aria-label={alt}
        >
          <div class="aspect-[4/3] overflow-hidden bg-surface">
            <img
              src={src480}
              srcset={`${src480} 480w, ${src960} 960w`}
              sizes="320px"
              alt={alt}
              loading="lazy"
              decoding="async"
              width="480"
              height="360"
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            />
          </div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="absolute bottom-4 left-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="text-white text-sm font-medium drop-shadow-lg">
              {categoryLabel}
            </span>
          </div>
        </a>
      );
    })}
  </div>

  <!-- Mobile View All Link -->
  <div class="container mx-auto px-4 mt-6 sm:hidden text-center">
    <a
      href={t.viewAllLink}
      class="inline-flex items-center gap-2 text-sm font-medium text-primary hover:text-primary-hover transition-colors"
    >
      {t.viewAll}
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={isRtl ? "M15 19l-7-7 7-7" : "M9 5l7 7-7 7"} />
      </svg>
    </a>
  </div>
</section>

<script define:vars={{ totalImages: displayImages.length, isRtl, t }}>
  (function() {
    const section = document.querySelector('.gallery-slider-section');
    if (!section) return;

    const slider = section.querySelector('#gallery-slider');
    const prevBtn = section.querySelector('#slider-prev');
    const nextBtn = section.querySelector('#slider-next');
    const sliderItems = section.querySelectorAll('.slider-item');
    const sliderStatus = section.querySelector('#gallery-slider-status');

    const scrollAmount = 320;
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const scrollBehavior = prefersReducedMotion ? 'auto' : 'smooth';
    let scrollRaf = null;

    function getCurrentIndex() {
      if (!slider || sliderItems.length === 0) return 0;
      const sliderRect = slider.getBoundingClientRect();
      const edge = isRtl ? sliderRect.right : sliderRect.left;
      let closestIndex = 0;
      let minDistance = Infinity;

      sliderItems.forEach((item, idx) => {
        const rect = item.getBoundingClientRect();
        const itemEdge = isRtl ? rect.right : rect.left;
        const distance = Math.abs(itemEdge - edge);
        if (distance < minDistance) {
          minDistance = distance;
          closestIndex = idx;
        }
      });

      return closestIndex;
    }

    function updateSliderStatus() {
      if (!sliderStatus || totalImages <= 0) return;
      const idx = getCurrentIndex();
      sliderStatus.textContent = `${t.image} ${idx + 1} / ${totalImages}`;
    }

    function scrollSlider(direction) {
      const base = direction === 'prev' ? -scrollAmount : scrollAmount;
      const scrollDir = isRtl ? -base : base;
      slider?.scrollBy({ left: scrollDir, behavior: scrollBehavior });
    }

    // Slider navigation
    prevBtn?.addEventListener('click', () => {
      scrollSlider('prev');
    });

    nextBtn?.addEventListener('click', () => {
      scrollSlider('next');
    });

    slider?.addEventListener('keydown', (e) => {
      if (!slider?.contains(document.activeElement)) return;
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        scrollSlider(isRtl ? 'next' : 'prev');
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        scrollSlider(isRtl ? 'prev' : 'next');
      }
    });

    slider?.addEventListener('scroll', () => {
      if (scrollRaf) cancelAnimationFrame(scrollRaf);
      scrollRaf = requestAnimationFrame(updateSliderStatus);
    });

    updateSliderStatus();
  })();
</script>

<script>
  import '../../scripts/glightbox-init';
</script>

<style>
  .slider-no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .slider-no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .slider-item img {
      transition: none;
    }

    #gallery-slider {
      scroll-behavior: auto;
    }
  }
</style>
