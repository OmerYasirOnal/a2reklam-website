---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  const services = await getCollection('services');

  // Load manifest for images
  const manifestPath = path.join(process.cwd(), 'public', 'images-manifest.json');
  let manifest = [];
  try {
    manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  } catch (e) {
    console.error('Manifest load error', e);
  }

  return services.map(entry => {
    // Filter images for this category
    const categoryImages = manifest.filter((m: any) => m.category === entry.slug);
    
    return {
      params: { slug: entry.slug },
      props: { entry, images: categoryImages },
    };
  });
}

const { entry, images } = Astro.props;
const { Content } = await entry.render();

const title = `${entry.data.title} - A2 Reklam`;
---

<Layout title={title} description={entry.data.description} lang="tr">
  <!-- Hero Section -->
  <div class="relative h-[50vh] flex items-center justify-center text-white">
    <div class="absolute inset-0 z-0">
      <img src={entry.data.heroImage} alt={entry.data.title} class="w-full h-full object-cover" />
      <div class="absolute inset-0 bg-secondary/80 mix-blend-multiply"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-secondary via-transparent to-transparent"></div>
    </div>
    <div class="relative z-10 container mx-auto px-4 mt-20">
      <h1 class="font-heading font-black text-4xl md:text-6xl mb-4 drop-shadow-lg">{entry.data.title}</h1>
      <ul class="flex gap-2 text-sm text-gray-300 font-medium tracking-wide">
        <li><a href="/" class="hover:text-primary transition-colors">Anasayfa</a></li>
        <li>/</li>
        <li><a href="/hizmetler/" class="hover:text-primary transition-colors">Hizmetler</a></li>
        <li>/</li>
        <li class="text-primary">{entry.data.title}</li>
      </ul>
    </div>
  </div>

  <div class="container mx-auto px-4 py-20 grid grid-cols-1 lg:grid-cols-3 gap-12">
    <!-- Main Content -->
    <div class="lg:col-span-2 prose prose-lg prose-invert max-w-none prose-headings:font-heading prose-headings:font-bold prose-a:text-primary prose-strong:text-white">
      <Content />
      
      {entry.data.features && (
        <div class="my-10 bg-accent-light p-8 rounded-xl border border-white/5 shadow-inner not-prose">
          <h3 class="font-heading font-bold text-2xl mb-6 text-white flex items-center gap-2">
            <span class="w-1 h-8 bg-primary block rounded-full"></span>
            Özellikler
          </h3>
          <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {entry.data.features.map((f: string) => (
              <li class="flex items-center gap-3 text-gray-300">
                <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-primary shrink-0">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </div>
                {f}
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Gallery Grid -->
      <div class="mt-20 not-prose">
        <h2 class="font-heading font-bold text-3xl mb-8 text-white border-b border-white/10 pb-4">İlgili Referans Görseller</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {images.map((img: any) => (
            <div class="aspect-square overflow-hidden rounded-lg bg-accent-light group relative cursor-pointer">
              <img 
                src={img.paths['480']} 
                data-full={img.paths['1600']}
                alt={img.alt_tr} 
                class="gallery-img w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 opacity-80 group-hover:opacity-100"
                loading="lazy" 
              />
              <div class="absolute inset-0 ring-1 ring-inset ring-white/10 group-hover:ring-primary/50 transition-all rounded-lg pointer-events-none"></div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class="space-y-8">
      <div class="bg-accent-light p-8 rounded-xl border border-white/5 sticky top-24 shadow-2xl">
        <h3 class="font-heading font-bold text-2xl mb-4 text-white uppercase tracking-tight">Hemen Teklif <span class="text-primary">Alın</span></h3>
        <p class="text-gray-400 mb-6 text-sm leading-relaxed">
          {entry.data.title} işleriniz için profesyonel destek ve fiyat teklifi almak için bize ulaşın. Genellikle 2 saat içinde dönüş yapıyoruz.
        </p>
        <div class="space-y-4">
          <a href="/teklif-al/" class="block w-full text-center bg-primary text-secondary font-black py-4 rounded-lg hover:bg-white transition-all transform hover:-translate-y-1 shadow-lg shadow-primary/20 uppercase tracking-widest text-sm">
            Teklif İste
          </a>
          <a href="https://wa.me/905555555555" class="flex items-center justify-center gap-2 w-full text-center bg-green-600 text-white font-bold py-4 rounded-lg hover:bg-green-500 transition-all border border-green-500/50">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.893-11.891 3.181 0 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.481 8.414 0 6.556-5.332 11.892-11.893 11.892-1.99 0-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.591 5.405 0 9.801-4.398 9.801-9.805 0-5.403-4.395-9.804-9.801-9.804-5.408 0-9.805 4.398-9.805 9.804 0 2.229.615 4.317 1.784 6.149l-1.109 4.041 4.139-1.08zm9.977-6.862c-.32-.16-1.89-.932-2.185-1.041-.297-.108-.512-.16-.726.16-.215.32-.834 1.042-1.023 1.256-.188.214-.377.241-.697.08-.32-.16-1.35-.497-2.57-1.587-.948-.847-1.59-1.893-1.777-2.214-.188-.321-.02-.494.14-.654.144-.143.32-.375.48-.563.16-.188.214-.321.32-.536.108-.214.054-.401-.027-.562-.08-.16-.726-1.751-.995-2.394-.26-.629-.53-.543-.726-.553-.188-.01-.403-.012-.617-.012s-.564.08-.859.401c-.296.321-1.128 1.102-1.128 2.688 0 1.587 1.155 3.118 1.316 3.332.16.214 2.274 3.472 5.508 4.871.77.333 1.37.532 1.839.681.773.245 1.477.211 2.032.128.618-.093 1.891-.773 2.158-1.517.268-.745.268-1.383.189-1.516-.08-.135-.297-.215-.617-.375z"/></svg>
            WhatsApp'tan Yaz
          </a>
        </div>
      </div>
    </aside>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 z-[100] bg-black/95 hidden flex-items-center justify-center p-4 cursor-zoom-out">
    <img id="lightbox-img" src="" alt="Lightbox" class="max-w-full max-h-full object-contain shadow-2xl transition-transform duration-300 transform scale-95" />
    <button id="close-lightbox" class="absolute top-6 right-6 text-white hover:text-primary transition-colors">
      <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
  </div>

  <script>
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const closeBtn = document.getElementById('close-lightbox');
    const galleryImages = document.querySelectorAll('.gallery-img');

    galleryImages.forEach(img => {
      img.addEventListener('click', () => {
        const fullSrc = img.getAttribute('data-full');
        if (fullSrc) {
          lightboxImg.src = fullSrc;
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
          setTimeout(() => lightboxImg.classList.remove('scale-95'), 10);
        }
      });
    });

    const close = () => {
      lightboxImg.classList.add('scale-95');
      setTimeout(() => {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
      }, 300);
    };

    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox || e.target === lightboxImg || e.target === closeBtn) {
        close();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  </script>
</Layout>
